<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="UTF-8">
<title>P2P Snake</title>
<link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<style>
  body { margin:0; font-family: 'Segoe UI', sans-serif; background: #121212; color: #fff; display: flex; flex-direction: column; align-items: center; overflow: hidden; height: 100vh; }
  canvas { background: #1a1a1a; border-radius: 12px; margin-top: 20px; box-shadow: 0 0 25px rgba(0,0,0,0.7); display: none; border: 2px solid #333; }
  
  #lobby, #gameOverOverlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10; text-align: center; }
  .hidden { display: none !important; }

  .box { background: #252525; padding: 30px; border-radius: 15px; border: 1px solid #444; box-shadow: 0 10px 30px rgba(0,0,0,0.5); min-width: 320px; }
  h1 { color: #00ffcc; margin: 0 0 20px 0; font-size: 32px; }
  h2 { color: #aaa; font-size: 18px; margin-bottom: 10px; }
  
  .code-display { font-size: 24px; font-weight: bold; color: #00ffcc; letter-spacing: 5px; background: #111; padding: 10px; border-radius: 8px; margin-bottom: 20px; border: 1px dashed #555; }
  
  input { padding: 12px; width: 200px; border-radius: 8px; border: 1px solid #555; background: #111; color: #00ffcc; margin-bottom: 15px; font-family: monospace; text-align: center; font-size: 18px; }
  button { padding: 12px 24px; border-radius: 8px; border: none; background: #00ffcc; color: #121212; font-weight: bold; cursor: pointer; transition: 0.3s; font-size: 16px; margin: 5px; }
  button:hover { background: #00ccaa; transform: scale(1.05); }
  button.secondary { background: #444; color: #fff; }

  #resultMessage { font-size: 48px; font-weight: bold; margin-bottom: 20px; }
  .win { color: #00ffcc; text-shadow: 0 0 15px #00ffcc; }
  .lose { color: #ff4444; text-shadow: 0 0 15px #ff4444; }
  #status { color: #888; margin-top: 15px; font-size: 14px; }

  /* MOBIL BLOKKOL√ì ST√çLUS */
  #mobileMsg {
    display: none;
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background: #121212;
    z-index: 1000;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    padding: 20px;
  }

  /* Ha a k√©perny≈ë 768px-n√©l kisebb, vagy √©rint≈ëk√©perny≈ës (durva becsl√©s) */
  @media (max-width: 768px) {
    #mobileMsg { display: flex; }
    #lobby, canvas, #gameOverOverlay { display: none !important; }
  }
</style>
</head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-F7NERFLG67"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-F7NERFLG67');
</script>
<body>

<div id="mobileMsg">
  <div class="box">
    <h1>Hopp√°! üêç</h1>
    <p>Ez a j√°t√©k billenty≈±zetet ig√©nyel.</p>
    <p style="color: #00ffcc; font-weight: bold;">K√©rj√ºk, csatlakozz sz√°m√≠t√≥g√©pr≈ël!</p>
  </div>
</div>

<div id="lobby">
  <div class="box" id="startBox">
    <h1>P2P Snake</h1>
    <button onclick="initHost()">J√°t√©k ind√≠t√°sa</button>
    <br><br>
    <div style="border-top: 1px solid #444; padding-top: 20px;">
      <h2>Csatlakoz√°s k√≥ddal:</h2>
      <input type="text" id="joinCodeInput" placeholder="ABC12">
      <br>
      <button class="secondary" onclick="joinByCode()">Csatlakoz√°s</button>
    </div>
  </div>

  <div class="box hidden" id="hostBox">
    <h1>P2P Snake</h1>
    <p>A csatlakoz√°si k√≥dod:</p>
    <div id="myCodeDisplay" class="code-display">----</div>
    <p id="status">V√°rakoz√°s a partnerre...</p>
    <button class="secondary" onclick="location.reload()">Vissza</button>
  </div>

  <div class="box hidden" id="guestBox">
    <h1>Csatlakoz√°s...</h1>
    <p>P√°lyam√©ret egyeztet√©se √©s bet√∂lt√©s.</p>
  </div>
</div>

<div id="gameOverOverlay" class="hidden">
  <div class="box">
    <div id="resultMessage"></div>
    <div id="hostControls" class="hidden">
      <button onclick="requestRestart()">√öj j√°t√©k ind√≠t√°sa</button>
    </div>
    <p id="guestWaiting" class="hidden">V√°rakoz√°s a Host ind√≠t√°s√°ra...</p>
  </div>
</div>

<canvas id="gameCanvas"></canvas>

<script>
const cellSize = 20;
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
let cols, rows;

const generateShortId = () => Math.random().toString(36).substring(2, 7).toUpperCase();

let peer = null;
let conn = null;
let isHost = false;
let gameRunning = false;
let gameState = null;

// Mobil ellen≈ërz√©s JavaScripttel is a biztons√°g kedv√©√©rt
function isMobile() {
    return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
}

window.onload = () => {
    if (isMobile()) {
        document.getElementById('mobileMsg').style.display = 'flex';
        return;
    }

    const urlParams = new URLSearchParams(window.location.search);
    const targetId = urlParams.get('peer');
    if (targetId) {
        joinByLink(targetId);
    }
};

// --- H√ÅL√ìZAT √âS J√ÅT√âK LOGIKA (V√°ltozatlan, a jav√≠tott UI-kezel√©ssel) ---

function initHost() {
    isHost = true;
    const shortId = generateShortId();
    peer = new Peer(shortId);

    peer.on('open', (id) => {
        document.getElementById('startBox').classList.add('hidden');
        document.getElementById('hostBox').classList.remove('hidden');
        document.getElementById('myCodeDisplay').innerText = id;
    });

    peer.on('connection', (c) => {
        conn = c;
        setupConnection();
    });

    peer.on('error', (err) => {
        if(err.type === 'unavailable-id') initHost();
        else alert("Hiba: " + err.type);
    });
}

function joinByCode() {
    const code = document.getElementById('joinCodeInput').value.trim().toUpperCase();
    if (!code) return alert("√çrj be egy k√≥dot!");
    joinByLink(code);
}

function joinByLink(targetId) {
    isHost = false;
    peer = new Peer();
    peer.on('open', () => {
        document.getElementById('startBox').classList.add('hidden');
        document.getElementById('hostBox').classList.add('hidden');
        document.getElementById('guestBox').classList.remove('hidden');
        conn = peer.connect(targetId);
        setupConnection();
    });
    peer.on('error', (err) => alert("Nem siker√ºlt csatlakozni. A k√≥d val√≥sz√≠n≈±leg hib√°s."));
}

function setupConnection() {
  conn.on('open', () => {
    const mySize = getMaxGridSize();
    if (!isHost) {
      conn.send({ type: 'dimensions', cols: mySize.c, rows: mySize.r });
    }
  });

  conn.on('data', (data) => {
    if (isHost) {
      if (data.type === 'dimensions') negotiateSize(data);
      if (data.type === 'input') updateDirection('d2', data.key);
    } else {
      if (data.type === 'init') {
        cols = data.cols; rows = data.rows;
        initCanvas();
      } else {
        gameState = data;
        draw();
        handleUIState(); 
      }
    }
  });
}

function getMaxGridSize() {
  return {
    c: Math.floor((window.innerWidth - 40) / cellSize),
    r: Math.floor((window.innerHeight - 100) / cellSize)
  };
}

function negotiateSize(guestSize) {
  const hostSize = getMaxGridSize();
  cols = Math.min(hostSize.c, guestSize.cols);
  rows = Math.min(hostSize.r, guestSize.rows);
  initCanvas();
  conn.send({ type: 'init', cols: cols, rows: rows });
  startNewRound();
}

function initCanvas() {
  canvas.width = cols * cellSize;
  canvas.height = rows * cellSize;
  canvas.style.display = "block";
  document.getElementById('lobby').classList.add('hidden');
}

function startNewRound() {
  gameState = {
    s1: [{x: 5, y: Math.floor(rows/2)}],
    s2: [{x: cols-6, y: Math.floor(rows/2)}],
    d1: {x: 1, y: 0},
    d2: {x: -1, y: 0},
    food: Array.from({length: Math.floor((cols*rows)/500)||1}, () => ({x: Math.floor(Math.random()*cols), y: Math.floor(Math.random()*rows)})),
    winner: null
  };
  handleUIState(); 
  if (!gameRunning) { gameRunning = true; gameLoop(); }
}

function gameLoop() {
  if (gameState.winner) { gameRunning = false; conn.send(gameState); handleUIState(); return; }
  updateSnake(gameState.s1, gameState.d1);
  updateSnake(gameState.s2, gameState.d2);
  checkCollisions();
  conn.send(gameState);
  draw();
  setTimeout(gameLoop, 110);
}

function updateSnake(snake, dir) {
  const head = { x: snake[0].x + dir.x, y: snake[0].y + dir.y };
  snake.unshift(head);
  const fIdx = gameState.food.findIndex(f => f.x === head.x && f.y === head.y);
  if (fIdx !== -1) gameState.food[fIdx] = { x: Math.floor(Math.random() * cols), y: Math.floor(Math.random() * rows) };
  else snake.pop();
}

function checkCollisions() {
  const h1 = gameState.s1[0], h2 = gameState.s2[0];
  const d1 = h1.x<0||h1.x>=cols||h1.y<0||h1.y>=rows||gameState.s1.slice(1).some(p=>p.x===h1.x&&p.y===h1.y)||gameState.s2.some(p=>p.x===h1.x&&p.y===h1.y);
  const d2 = h2.x<0||h2.x>=cols||h2.y<0||h2.y>=rows||gameState.s2.slice(1).some(p=>p.x===h2.x&&p.y===h2.y)||gameState.s1.some(p=>p.x===h2.x&&p.y===h2.y);
  if (d1 && d2) gameState.winner = 'draw'; else if (d1) gameState.winner = 2; else if (d2) gameState.winner = 1;
}

document.addEventListener('keydown', (e) => {
  const key = e.key.toLowerCase();
  if (!['w','a','s','d'].includes(key)) return;
  if (isHost) updateDirection('d1', key);
  else if (conn) conn.send({ type: 'input', key: key });
});

function updateDirection(dirKey, key) {
  const d = gameState[dirKey];
  if (key === 'w' && d.y === 0) gameState[dirKey] = {x: 0, y: -1};
  if (key === 's' && d.y === 0) gameState[dirKey] = {x: 0, y: 1};
  if (key === 'a' && d.x === 0) gameState[dirKey] = {x: -1, y: 0};
  if (key === 'd' && d.x === 0) gameState[dirKey] = {x: 1, y: 0};
}

function handleUIState() {
  const overlay = document.getElementById('gameOverOverlay');
  const hostControls = document.getElementById('hostControls');
  const guestWaiting = document.getElementById('guestWaiting');

  if (gameState && gameState.winner) {
    overlay.classList.remove('hidden');
    const msg = document.getElementById('resultMessage');
    if (gameState.winner === 'draw') msg.innerText = "D√ñNTETLEN!";
    else {
      const iWon = (isHost && gameState.winner === 1) || (!isHost && gameState.winner === 2);
      msg.innerText = iWon ? "NYERT√âL!" : "VESZTETT√âL!";
      msg.className = iWon ? "win" : "lose";
    }
    if (isHost) { hostControls.classList.remove('hidden'); guestWaiting.classList.add('hidden'); }
    else { hostControls.classList.add('hidden'); guestWaiting.classList.remove('hidden'); }
  } else {
    overlay.classList.add('hidden');
  }
}

function requestRestart() { if (isHost) startNewRound(); }

function draw() {
  if (!gameState) return;
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.fillStyle = 'orange';
  gameState.food.forEach(f => ctx.fillRect(f.x*cellSize+4, f.y*cellSize+4, cellSize-8, cellSize-8));
  const mySnake = isHost ? gameState.s1 : gameState.s2;
  const enemySnake = isHost ? gameState.s2 : gameState.s1;
  ctx.fillStyle = '#ffffff';
  enemySnake.forEach(p => ctx.fillRect(p.x*cellSize+1, p.y*cellSize+1, cellSize-2, cellSize-2));
  ctx.fillStyle = '#00d9ff';
  mySnake.forEach(p => ctx.fillRect(p.x*cellSize+1, p.y*cellSize+1, cellSize-2, cellSize-2));
}
</script>
</body>
</html>