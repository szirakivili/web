<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="UTF-8">
<title>P2P Snake</title>
<link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<style>
  body { margin:0; font-family: 'Segoe UI', sans-serif; background: #121212; color: #fff; display: flex; flex-direction: column; align-items: center; overflow: hidden; height: 100vh; }
  canvas { background: #1a1a1a; border-radius: 12px; margin-top: 20px; box-shadow: 0 0 25px rgba(0,0,0,0.7); display: none; border: 2px solid #333; }
  
  #lobby, #gameOverOverlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10; text-align: center; }
  .hidden { display: none !important; }

  .box { background: #252525; padding: 30px; border-radius: 15px; border: 1px solid #444; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
  h1 { color: #00ffcc; margin: 0 0 20px 0; font-size: 32px; }
  
  input#inviteLink { padding: 12px; width: 280px; border-radius: 8px; border: 1px solid #555; background: #111; color: #00ffcc; margin-bottom: 15px; font-family: monospace; }
  button { padding: 12px 24px; border-radius: 8px; border: none; background: #00ffcc; color: #121212; font-weight: bold; cursor: pointer; transition: 0.3s; font-size: 16px; }
  button:hover { background: #00ccaa; transform: scale(1.05); }

  #resultMessage { font-size: 48px; font-weight: bold; margin-bottom: 20px; }
  .win { color: #00ffcc; text-shadow: 0 0 15px #00ffcc; }
  .lose { color: #ff4444; text-shadow: 0 0 15px #ff4444; }
  #guestWaiting { font-style: italic; color: #aaa; }
</style>
</head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-F7NERFLG67"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-F7NERFLG67');
</script>
<body>

<div id="lobby">
  <div class="box" id="hostBox">
    <h1>P2P Snake</h1>
    <p>Küldd el ezt a linket a barátodnak:</p>
    <input type="text" id="inviteLink" readonly>
    <button onclick="copyLink()">Link másolása</button>
    <p id="status">Várakozás a partnerre...</p>
  </div>
  <div class="box hidden" id="guestBox">
    <h1>Csatlakozás...</h1>
    <p>Pályaméret egyeztetése és betöltés.</p>
  </div>
</div>

<div id="gameOverOverlay" class="hidden">
  <div class="box">
    <div id="resultMessage"></div>
    <div id="hostControls" class="hidden">
      <button onclick="requestRestart()">Új játék indítása</button>
    </div>
    <p id="guestWaiting" class="hidden">Várakozás az újraindítására...</p>
  </div>
</div>

<canvas id="gameCanvas"></canvas>

<script>
// --- KONFIGURÁCIÓ ---
const cellSize = 20;
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
let cols, rows;

// Megkeresi a böngésző számára még kényelmes legnagyobb rácsot
function getMaxGridSize() {
  return {
    c: Math.floor((window.innerWidth - 40) / cellSize),
    r: Math.floor((window.innerHeight - 100) / cellSize)
  };
}

// --- HÁLÓZAT (PeerJS) ---
let peer = new Peer();
let conn = null;
let isHost = false;
let gameRunning = false;
let gameState = null;

peer.on('open', (id) => {
  const urlParams = new URLSearchParams(window.location.search);
  const targetId = urlParams.get('peer');

  if (targetId) {
    isHost = false;
    document.getElementById('hostBox').classList.add('hidden');
    document.getElementById('guestBox').classList.remove('hidden');
    conn = peer.connect(targetId);
    setupConnection();
  } else {
    isHost = true;
    document.getElementById('inviteLink').value = window.location.origin + window.location.pathname + '?peer=' + id;
  }
});

peer.on('connection', (c) => {
  if (isHost) {
    conn = c;
    setupConnection();
  }
});

function setupConnection() {
  conn.on('open', () => {
    const mySize = getMaxGridSize();
    if (!isHost) {
      // Vendég elküldi a saját max méretét
      conn.send({ type: 'dimensions', cols: mySize.c, rows: mySize.r });
    }
  });

  conn.on('data', (data) => {
    if (isHost) {
      if (data.type === 'dimensions') negotiateSize(data);
      if (data.type === 'input') updateDirection('d2', data.key);
    } else {
      if (data.type === 'init') {
        cols = data.cols;
        rows = data.rows;
        initCanvas();
      } else {
        gameState = data;
        draw();
        handleUIState();
      }
    }
  });
}

// --- PÁLYA EGYEZTETÉS ---
function negotiateSize(guestSize) {
  const hostSize = getMaxGridSize();
  cols = Math.min(hostSize.c, guestSize.cols);
  rows = Math.min(hostSize.r, guestSize.rows);
  
  initCanvas();
  conn.send({ type: 'init', cols: cols, rows: rows });
  startNewRound();
}

function initCanvas() {
  canvas.width = cols * cellSize;
  canvas.height = rows * cellSize;
  canvas.style.display = "block";
  document.getElementById('lobby').classList.add('hidden');
}

// --- JÁTÉK LOGIKA (Csak a Host futtatja) ---
function spawnFoodBatch() {
  const totalCells = cols * rows;
  const foodCount = Math.floor(totalCells / 500) || 1;
  const foods = [];
  while (foods.length < foodCount) {
    const pos = { x: Math.floor(Math.random() * cols), y: Math.floor(Math.random() * rows) };
    foods.push(pos);
  }
  return foods;
}

function getInitialState() {
  return {
    s1: [{x: 5, y: Math.floor(rows/2)}],
    s2: [{x: cols-6, y: Math.floor(rows/2)}],
    d1: {x: 1, y: 0},
    d2: {x: -1, y: 0},
    food: spawnFoodBatch(),
    winner: null
  };
}

function startNewRound() {
  gameState = getInitialState();
  document.getElementById('gameOverOverlay').classList.add('hidden');
  if (!gameRunning) {
    gameRunning = true;
    gameLoop();
  }
}

function gameLoop() {
  if (gameState.winner) {
    gameRunning = false;
    conn.send(gameState);
    handleUIState();
    return;
  }

  updateSnake(gameState.s1, gameState.d1);
  updateSnake(gameState.s2, gameState.d2);
  checkCollisions();

  conn.send(gameState);
  draw();
  setTimeout(gameLoop, 110);
}

function updateSnake(snake, dir) {
  const head = { x: snake[0].x + dir.x, y: snake[0].y + dir.y };
  snake.unshift(head);
  
  const foodIndex = gameState.food.findIndex(f => f.x === head.x && f.y === head.y);
  if (foodIndex !== -1) {
    // Új kaja generálása a megevett helyett
    gameState.food[foodIndex] = { x: Math.floor(Math.random() * cols), y: Math.floor(Math.random() * rows) };
  } else {
    snake.pop();
  }
}

function checkCollisions() {
  const h1 = gameState.s1[0];
  const h2 = gameState.s2[0];
  
  const dead1 = h1.x < 0 || h1.x >= cols || h1.y < 0 || h1.y >= rows || 
                gameState.s1.slice(1).some(p => p.x === h1.x && p.y === h1.y) ||
                gameState.s2.some(p => p.x === h1.x && p.y === h1.y);
                
  const dead2 = h2.x < 0 || h2.x >= cols || h2.y < 0 || h2.y >= rows || 
                gameState.s2.slice(1).some(p => p.x === h2.x && p.y === h2.y) ||
                gameState.s1.some(p => p.x === h2.x && p.y === h2.y);

  if (dead1 && dead2) gameState.winner = 'draw';
  else if (dead1) gameState.winner = 2;
  else if (dead2) gameState.winner = 1;
}

// --- IRÁNYÍTÁS ---
document.addEventListener('keydown', (e) => {
  const key = e.key.toLowerCase();
  if (!['w','a','s','d'].includes(key)) return;
  if (isHost) updateDirection('d1', key);
  else conn.send({ type: 'input', key: key });
});

function updateDirection(dirKey, key) {
  const d = gameState[dirKey];
  if (key === 'w' && d.y === 0) gameState[dirKey] = {x: 0, y: -1};
  if (key === 's' && d.y === 0) gameState[dirKey] = {x: 0, y: 1};
  if (key === 'a' && d.x === 0) gameState[dirKey] = {x: -1, y: 0};
  if (key === 'd' && d.x === 0) gameState[dirKey] = {x: 1, y: 0};
}

function handleUIState() {
  if (gameState.winner) {
    const overlay = document.getElementById('gameOverOverlay');
    const msg = document.getElementById('resultMessage');
    overlay.classList.remove('hidden');
    
    if (gameState.winner === 'draw') {
      msg.innerText = "DÖNTETLEN!";
      msg.className = "";
    } else {
      const iWon = (isHost && gameState.winner === 1) || (!isHost && gameState.winner === 2);
      msg.innerText = iWon ? "NYERTÉL!" : "VESZTETTÉL!";
      msg.className = iWon ? "win" : "lose";
    }

    if (isHost) document.getElementById('hostControls').classList.remove('hidden');
    else document.getElementById('guestWaiting').classList.remove('hidden');
  } else {
    document.getElementById('gameOverOverlay').classList.add('hidden');
  }
}

function requestRestart() { if (isHost) startNewRound(); }

// --- RAJZOLÁS ---
function draw() {
  if (!gameState) return;
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  // Kaják (narancssárga bogyók)
  ctx.fillStyle = 'orange';
  gameState.food.forEach(f => {
    ctx.beginPath();
    ctx.arc(f.x * cellSize + cellSize/2, f.y * cellSize + cellSize/2, cellSize/3, 0, Math.PI*2);
    ctx.fill();
  });

  // Kígyók színei: Te = kék, Ellenfél = fehér
  const mySnake = isHost ? gameState.s1 : gameState.s2;
  const enemySnake = isHost ? gameState.s2 : gameState.s1;

  // Ellenfél rajzolása
  ctx.fillStyle = '#ffffff';
  enemySnake.forEach(p => ctx.fillRect(p.x * cellSize + 1, p.y * cellSize + 1, cellSize - 2, cellSize - 2));

  // Saját kígyó rajzolása (teljesen kék)
  ctx.fillStyle = '#00d9ff';
  mySnake.forEach(p => ctx.fillRect(p.x * cellSize + 1, p.y * cellSize + 1, cellSize - 2, cellSize - 2));
}

function copyLink() {
  const link = document.getElementById('inviteLink');
  link.select();
  document.execCommand('copy');
  alert('Link másolva a vágólapra!');
}
</script>
</body>
</html>