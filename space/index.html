<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8" />
  <title>Űrbéli dolgok</title>
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />

  <style>
    :root {
      --bg: #0f1117;
      --card: #1c1f26;
      --text: #e0e4ef;
      --accent: #00b7ff;
      --border: #2a2d35;
      --subtle-text: #9ba1b4;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--bg);
      color: var(--text);
      padding: 2rem;
      line-height: 1.6;
    }

    .container {
      max-width: 800px;
      margin: auto;
    }

    h2 {
      margin-bottom: 1rem;
      color: var(--accent);
      font-size: 1.75rem;
      font-weight: 700;
      letter-spacing: -0.5px;
      border-bottom: 2px solid var(--border);
      padding-bottom: 0.5rem;
    }
    
    #docked-objects-container {
      margin-top: 1rem;
    }

    .button-container {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1rem;
    }

    #fetch-button, #launches-button, #crewed-launches-button {
      background-color: var(--accent);
      color: var(--bg);
      border: none;
      padding: 0.75rem 1.5rem;
      font-size: 1rem;
      font-weight: 600;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.3s ease, transform 0.2s ease;
    }

    #fetch-button:hover:not(:disabled), #launches-button:hover:not(:disabled), #crewed-launches-button:hover:not(:disabled) {
      background-color: #0099e6;
      transform: translateY(-2px);
    }
    
    #fetch-button:disabled, #launches-button:disabled, #crewed-launches-button:disabled {
      background-color: #6c757d;
      cursor: not-allowed;
      opacity: 0.7;
    }

    #map {
      width: 100%;
      height: 400px;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 15px rgba(0, 183, 255, 0.2);
      margin-bottom: 2rem;
      border: 1px solid var(--border);
    }

    .object-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 1rem;
    }

    .object-card {
      background-color: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.5rem;
      transition: all 0.3s ease;
      position: relative;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .object-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0, 183, 255, 0.15);
      border-color: var(--accent);
    }

    .object-name {
      display: flex;
      align-items: baseline;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }

    .object-name h3 {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--text);
    }

    .object-id {
      font-size: 0.8rem;
      color: var(--subtle-text);
      font-weight: 400;
      background-color: var(--border);
      padding: 0.2rem 0.5rem;
      border-radius: 8px;
    }

    .object-info p {
      font-size: 0.9rem;
      color: var(--subtle-text);
      margin: 0.25rem 0;
    }

    .object-info p strong {
      color: var(--accent);
      font-weight: 600;
    }

    .object-info h4 {
      font-size: 1rem;
      color: var(--accent);
      margin-bottom: 0.5rem;
    }

    .status-badge {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: var(--border);
      padding: 0.3rem 0.6rem;
      border-radius: 6px;
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--accent);
    }

    .launch-logos {
      display: flex;
      flex-wrap: wrap; /* új sor, ha nem fér ki */
      gap: 0.5rem;
    }

    .launch-logo-patch {
      max-width: 100px;
      max-height: 100px;
      object-fit: contain;
    }
    .launch-logo-image {
      max-width: 100px;
      max-height: 100px;
      object-fit: contain;
      margin-bottom: 0.5rem;
      border-radius: 10%;
    }
    .crew-list {
      margin-top: 0.5rem;
    }

    .crew-list h4 {
      font-size: 1rem;
      color: var(--accent);
      margin-bottom: 0.5rem;
    }

    .crew-list ul {
      list-style: none;
      padding-left: 0;
      margin: 0;
    }

    .crew-list li {
      position: relative;
      padding-left: 1.5rem;
      margin-bottom: 0.5rem;
      font-size: 0.9rem;
      color: var(--subtle-text);
    }

    .crew-list li strong {
      color: var(--accent);
      font-weight: 600;
    }

    .crew-list li::before {
      content: "✦";              /* egyszerű, modern "csillag" ikon */
      position: absolute;
      left: 0;
      color: var(--accent);
      font-size: 0.9rem;
    }

    @media (max-width: 600px) {
      body {
        padding: 1rem;
      }
      .object-list {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-F7NERFLG67"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-F7NERFLG67');
</script>
<body>
  <div class="container">
    <div id="apod-section" class="object-card" style="margin-bottom: 2rem;">
      <h2>
        A nap csillagászati képe a NASA-tól
        <span class="object-id" style="margin: 5px; cursor: pointer;" onclick="window.open('https://apod.nasa.gov/apod/')">Forrás</span>
      </h2>
      <div id="apod-content">Betöltés...</div>
    </div>
    
    <h2>A Nemzetközi Űrállomás aktuális pozíciója</h2>
    <div id="map"></div>
    <div id="iss-info" class="object-card" style="margin-bottom: 2rem;"></div>

    <h2>Közelgő személyzet nélküli kilövések</h2>
    <div id="launches-container">
      <button id="launches-button">Lista betöltése</button>
      <div id="launches" class="object-list" style="margin-bottom:2rem;"></div>
    </div>

    <h2>Közelgő emberes kilövések</h2>
    <div id="launches-container">
      <button id="crewed-launches-button">Lista betöltése</button>
      <div id="crewed-launches" class="object-list" style="margin-bottom:2rem;"></div>
    </div>

    <h2>Űrállomások és dokkolt járművek az űrben</h2>
    <div id="docked-objects-container">
      <button id="fetch-button">Lista betöltése</button>
      <div id="objects" class="object-list"></div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    let marker = null;
    let issCircle = null;

    function formatTimeAgo(isoString) {
      const then = new Date(isoString);
      const now = new Date();
      const diffMs = now - then;
      const seconds = Math.floor(diffMs / 1000);
      const minutes = Math.floor(seconds / 60);
      const hours = Math.floor(minutes / 60);
      const days = Math.floor(hours / 24);

      if (days > 0) return `${days} napja`;
      if (hours > 0) return `${hours} órája`;
      if (minutes > 0) return `${minutes} perce`;
      return `${seconds} másodperce`;
    }

    function formatCountdown(isoString) {
      const launchDate = new Date(isoString);
      const now = new Date();
      let diff = (launchDate - now) / 1000; // másodpercben
      if (diff <= 0) return "Már elindult";

      const days = Math.floor(diff / 86400);
      diff %= 86400;
      const hours = Math.floor(diff / 3600);
      diff %= 3600;
      const minutes = Math.floor(diff / 60);
      const seconds = Math.floor(diff % 60);

      const dd = String(days).padStart(2, '0');
      const hh = String(hours).padStart(2, '0');
      const mm = String(minutes).padStart(2, '0');
      const ss = String(seconds).padStart(2, '0');

      return `T-${dd}:${hh}:${mm}:${ss}`;
    }

    function formatLaunchDate(isoString, precision) {
      const date = new Date(isoString);

      const months = [
        "január", "február", "március", "április", "május", "június",
        "július", "augusztus", "szeptember", "október", "november", "december"
      ];

      const pad = (n) => String(n).padStart(2, "0");

      let formatted = "";

      switch (precision) {
        case "Y":
          formatted = `${date.getFullYear()}`;
          break;

        case "M":
          formatted = `${date.getFullYear()}. ${months[date.getMonth()]}`;
          break;

        case "DAY":
          formatted = `${date.getFullYear()}. ${months[date.getMonth()]} ${date.getDate()}.`;
          break;

        case "HR":
          formatted = `${date.getFullYear()}. ${months[date.getMonth()]} ${date.getDate()}. ${pad(date.getHours())}:00`;
          break;

        case "MIN":
          formatted = `${date.getFullYear()}. ${months[date.getMonth()]} ${date.getDate()}. ${pad(date.getHours())}:${pad(date.getMinutes())}`;
          break;

        case "SEC":
          formatted = `${date.getFullYear()}. ${months[date.getMonth()]} ${date.getDate()}. ${pad(date.getHours())}:${pad(date.getMinutes())}:${pad(date.getSeconds())}`;
          break;

        case "Q1":
        case "Q2":
        case "Q3":
        case "Q4": 
          formatted = `${date.getFullYear()}. ${precision[1]}. negyedév`;
          break;

        case "H1":
        case "H2": 
          formatted = `${date.getFullYear()}. ${precision[1]}. fele`;
          break;

        default:
          formatted = `Ismeretlen (${date.toLocaleString("hu-HU")}`; // fallback: teljes dátum/idő magyarul
      }

      return formatted;
    }

    const map = L.map('map', {
      zoomControl: false,
      dragging: false,
      scrollWheelZoom: false,
      doubleClickZoom: false,
      touchZoom: false,
      boxZoom: false,
      keyboard: false
    });
    map.setView([0, 0], 2);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    const issIcon = L.icon({
      iconUrl: 'https://upload.wikimedia.org/wikipedia/commons/d/d0/International_Space_Station.svg',
      iconSize: [70, 45],
      iconAnchor: [35, 22.5]
    });

    async function fetchWithTimeout(url, timeout = 3000) {
      return Promise.race([
        fetch(url),
        new Promise((_, reject) => setTimeout(() => reject(new Error("timeout")), timeout))
      ]);
    }

    async function updateISSPosition() {
      try {
        let data, lat, lon, weakAPI = false;
        try {
          const response = await fetchWithTimeout('https://api.wheretheiss.at/v1/satellites/25544', 3000);
          if (!response.ok) throw new Error("Első API hibás választ adott");
          data = await response.json();
          lat = data.latitude;
          lon = data.longitude;
        } catch (err) {
          console.warn("Első API nem válaszolt:", err.message);
          const response = await fetch('http://api.open-notify.org/iss-now.json');
          if (!response.ok) throw new Error("Második API hibás választ adott");
          data = await response.json();
          lat = data.iss_position.latitude;
          lon = data.iss_position.longitude;
          weakAPI = true;
        }

        if (!marker) {
          marker = L.marker([lat, lon], { icon: issIcon }).addTo(map);
          marker.bindPopup("ISS");
          issCircle = L.circle([lat, lon], {
            radius: 1700000,
            color: '#00b7ff',
            fillColor: '#00b7ff',
            fillOpacity: 0.2,
            weight: 1
          }).addTo(map);
        } else {
          marker.setLatLng([lat, lon]);
          issCircle.setLatLng([lat, lon]);
        }

        map.setView([lat, lon], 2);
        renderISSInfo(data, weakAPI);

      } catch (error) {
        console.error('Hiba az ISS pozíció lekérdezésénél:', error);
      }
    }

    const issInfoDiv = document.getElementById('iss-info');
    function renderISSInfo(data, weakAPI = false) {
      if (!weakAPI) {
        const visibility = data.visibility === 'daylight' ? 'nappali' : 'éjszakai';
        issInfoDiv.innerHTML = `
          <div class="object-name">
            <h3>ISS</h3>
            <span class="object-id">ID: ${data.id}</span>
          </div>
          <div class="object-info">
            <p>Magasság: <strong>${data.altitude.toFixed(1)} km</strong></p>
            <p>Sebesség: <strong>${data.velocity.toFixed(0)} km/h</strong></p>
            <p>Láthatóság: <strong>${visibility}</strong></p>
          </div>
        `;
      } else {
        issInfoDiv.innerHTML = `
          <div class="object-name">
            <h3>ISS</h3>
          </div>
          <div class="object-info">
            <p>A wheretheiss.at oldal nem válaszol. <strong>Részletes információk nem érhetők el.</strong></p>
          </div>
        `;
      }
    }

    async function fetchLaunches(isCrewed = false) {
      const container = document.getElementById(`${isCrewed ? "crewed-" : ""}launches`);
      const button = document.getElementById(`${isCrewed ? "crewed-" : ""}launches-button`);
      button.disabled = true;
      button.textContent = "Betöltés...";

      try {
        const response = await fetch(`https://ll.thespacedevs.com/2.3.0/launches/upcoming/?is_crewed=${isCrewed}&format=json&mode=detailed&limit=10`);
        const data = await response.json();
        container.innerHTML = "";

        if (data.detail) {
          let waitSec = data.detail.split(" ")[6];
          button.style.display = "none";
          container.innerHTML = `<p>Próbáld újra ${waitSec} mp múlva!</p>`;
          return;
        }

        data.results.forEach((launch, index) => {
          const div = document.createElement("div");
          div.className = "object-card";
          
          let logo = "";
          let logoClass = "";
          if (launch.mission_patches && launch.mission_patches.length > 0) {
            launch.mission_patches.forEach((patch) => {
              logo += `<img class="launch-logo-patch" src="${patch.image_url}" alt="${patch.name}" />`;
            });
          } else if (launch.program && launch.program.length > 0 && launch.program[0].image) {
            logo = `<img class="launch-logo-image" src="${launch.program[0].image.image_url}" alt="${launch.program[0].image.name}" />`;
          } else if (launch.image) {
            logo = `<img class="launch-logo-image" src="${launch.image.image_url}" alt="${launch.image.name}" />`;
          }

          let crew = "";
          if (isCrewed && launch.rocket && launch.rocket.spacecraft_stage && launch.rocket.spacecraft_stage.length > 0 && launch.rocket.spacecraft_stage[0].launch_crew && launch.rocket.spacecraft_stage[0].launch_crew.length > 0)
          {
            launch.rocket.spacecraft_stage[0].launch_crew.forEach(member => {
              crew += `<li>${member.role.role || "Űrhajós"}: <strong>${member.astronaut.name}</strong> (${member.astronaut.nationality[0].alpha_2_code || "?"})</li>`;
            });
          }

          // minden launch-hoz adunk egy egyedi ID-t a visszaszámlálóhoz
          const countdownId = `countdown-${isCrewed ? "C" : "UC"}${index}`;

          div.innerHTML = `
            <span class="status-badge">${launch.status?.name || launch.status?.abbrev || ""}</span>
            <div class="launch-logos">${logo ? logo : ""}</div>
            <div class="object-name">
              <h3>${launch.name}</h3>
            </div>
            <div class="object-info">
              <h4><strong id="${countdownId}">${formatCountdown(launch.net)}</strong></h4>
              <p>Indítás időpontja: <strong>${formatLaunchDate(launch.net, launch.net_precision?.abbrev || null)}</strong></p>
              <p>Helyszín: <strong>${launch.pad?.location?.name || launch.pad?.name || "Ismeretlen"}</strong> (${launch.location_launch_attempt_count_year}. kilövés az évben)</p>
              <p>Szolgáltató: <strong>${launch.launch_service_provider?.name || "N/A"}</strong> (${launch.agency_launch_attempt_count_year}. kilövés az évben)</p>
              <p>Keringési pálya: <strong>${launch.mission?.orbit?.name || "-"}</strong> (${launch.mission?.orbit?.abbrev || ""})</p>
              ${isCrewed ? `<div class="crew-list">
                  <h4>Személyzet:</h4>
                  <ul>${crew}</ul>
                </div>` : ""}
              <h4>A küldetésről:</h4>
              <p>${launch.mission?.description || "-"}</p>
              <p class="object-id" style="margin-top: 15px; cursor: pointer; width: fit-content;" onclick="window.open('https://go4liftoff.com/launch/${launch.slug}')">További információk</p>
            </div>
          `;
          container.appendChild(div);

          // indítjuk a frissítőt az adott launch-hoz
          const countdownEl = document.getElementById(countdownId);
          setInterval(() => {
            countdownEl.textContent = formatCountdown(launch.net);
          }, 1000);
        });

        button.style.display = "none"; // eltüntetjük a gombot sikeres betöltés után
      } catch (err) {
        console.error("Nem sikerült lekérni a kilövéseket:", err);
        container.innerHTML = "<p>Nem sikerült betölteni a kilövéseket.</p>";
        button.textContent = "Újra próbálkozás";
        button.disabled = false;
      }
    }

    async function fetchDockedObjects() {
      const listContainer = document.getElementById('objects');
      const button = document.getElementById('fetch-button');
      button.disabled = true;
      button.textContent = 'Betöltés...';

      try {
        const response = await fetch('https://celestrak.org/NORAD/elements/gp.php?GROUP=stations&FORMAT=json');
        const data = await response.json();

        data.sort((a, b) => b.OBJECT_ID.localeCompare(a.OBJECT_ID));
        listContainer.innerHTML = '';

        data.forEach(obj => {
          const div = document.createElement('div');
          div.className = 'object-card';
          div.innerHTML = `
            <div class="object-name">
              <h3>${obj.OBJECT_NAME}</h3>
              <span class="object-id">${obj.OBJECT_ID}</span>
            </div>
            <div class="object-info">
              <p>Frissítve: <strong>${formatTimeAgo(obj.EPOCH)}</strong></p>
              <p>Keringési pálya szöge: <strong>${obj.INCLINATION}°</strong></p>
            </div>
          `;
          listContainer.appendChild(div);
        });
        button.style.display = 'none';
      } catch (error) {
        console.error('Nem sikerült lekérni a dokkolt objektumokat:', error);
        button.textContent = 'Hiba történt';
        button.disabled = false;
      }
    }

    async function fetchAPOD() {
      const apodDiv = document.getElementById('apod-content');
      try {
        const response = await fetch('https://api.nasa.gov/planetary/apod?api_key=RNbnPzZa0FI95pg1kH0MOtYh8dHBUada1cMG1FbE');
        const data = await response.json();

        if (data.media_type !== 'image') {
          apodDiv.innerHTML = '<p>Mai napra nincs elérhető kép.</p>';
        } else {
          apodDiv.innerHTML = `
          <a href="${data.hdurl}" target="_blank" style="display:block; margin-bottom:1rem;">
            <img src="${data.url}" alt="${data.title}" style="max-width:100%; border-radius:12px; border: 1px solid var(--border); box-shadow: 0 4px 15px rgba(0, 183, 255, 0.1);" />
          </a>`;
        }

        apodDiv.innerHTML += `
          <h3 style="color: var(--accent); font-size: 1.10rem; margin-bottom: 0.5rem;">${data.title}</h3>
          <p style="font-size: 0.95rem; color: var(--subtle-text);">${data.explanation}</p>
        `;
      } catch (err) {
        console.error('Nem sikerült lekérni a NASA képét:', err);
        apodDiv.innerHTML = '<p>Hiba történt a kép betöltésekor.</p>';
      }
    }

    fetchAPOD();

    updateISSPosition();
    setInterval(updateISSPosition, 5000);

    document.getElementById('fetch-button').addEventListener('click', fetchDockedObjects);
    document.getElementById('launches-button').addEventListener('click', () => fetchLaunches(false));
    document.getElementById('crewed-launches-button').addEventListener('click', () => fetchLaunches(true));
  </script>
</body>
</html>
