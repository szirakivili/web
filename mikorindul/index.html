<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Következő indulás</title>
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f9f9f9;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      text-align: center;
    }

    .time-remaining {
      font-size: 6rem;
      font-weight: bold;
      color: #222;
      display: flex;
      align-items: center;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .departure-info {
      font-size: 1.5rem;
      margin-top: 1rem;
      color: black;
    }

    .route-info {
      font-size: 1rem;
      color: black;
      margin-top: 0.8rem;
    }

    .vehicle-info {
      margin-top: 0.3rem;
      font-size: 0.8rem;
      color: black;
      font-style: italic;
    }

    .next-stop {
      margin-top: 0.3rem;
      font-size: 0.8rem;
      color: blue;
    }

    .realtime-indicator {
      display: inline-block;
      width: 10px;
      height: 10px;
      background-color: #28a745;
      border-radius: 50%;
      animation: blink 3s infinite ease-in-out;
      box-shadow: 0 0 8px 2px rgba(40, 167, 69, 0.6);
      flex-shrink: 0;
    }

    @keyframes blink {
      0% { opacity: 1; }
      50% { opacity: 0.3; }
      100% { opacity: 1; }
    }

    .error {
      color: red;
      font-size: 1.2rem;
      margin-top: 1rem;
    }

    .time-on-time {
      color: #28a745;
    }

    .time-delayed {
      color: #dc3545;
    }

    input[type="text"] {
      font-size: 1.5rem;
      padding: 0.5rem;
      width: 80%;
      max-width: 400px;
    }

    button {
      font-size: 1.2rem;
      padding: 0.5rem 1rem;
      margin-top: 1rem;
    }

    #searchResults > div {
      margin: 0.5rem;
    }

    #searchResults a {
      text-decoration: none;
      font-size: 1.2rem;
      color: #007bff;
    }

    .search-container {
      background: white;
      padding: 2rem;
      border-radius: 1rem;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      text-align: center;
      max-width: 500px;
      width: 100%;
      box-sizing: border-box;
      margin: 0 auto;
    }

    .search-container h1 {
      font-size: 2rem;
      margin-bottom: 1rem;
      color: #333;
    }

    .search-container input[type="text"] {
      font-size: 1.2rem;
      padding: 0.75rem 1rem;
      width: 100%;
      max-width: 100%;
      border: 1px solid #ccc;
      border-radius: 8px;
      box-sizing: border-box;
    }

    .search-container button {
      font-size: 1rem;
      padding: 0.6rem 1.2rem;
      margin-top: 1rem;
      border: none;
      background-color: #007bff;
      color: white;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    .search-container button:hover {
      background-color: #0056b3;
    }

    .scrollable-box {
      margin-top: 2rem;
      max-height: 250px;
      overflow-y: auto;
      border-top: 1px solid #ddd;
      padding-top: 1rem;
      text-align: left;
    }

    .scrollable-box div {
      margin: 0.5rem 0;
    }

    .scrollable-box a {
      text-decoration: none;
      font-size: 1.1rem;
      color: #007bff;
      display: block;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      transition: background-color 0.2s ease;
    }

    .scrollable-box a:hover {
      background-color: #f1f1f1;
    }

    /* Mobil optimalizálás */
    @media (max-width: 600px) {
      body {
        padding: 1rem;
      }

      .time-remaining {
        font-size: 4rem;
      }

      .departure-info {
        font-size: 1rem;
      }

      .route-info {
        font-size: 1rem;
      }

      input[type="text"],
      .search-container input[type="text"] {
        font-size: 1.1rem;
        padding: 0.6rem 0.8rem;
        width: 100%;
        box-sizing: border-box;
      }

      .search-container button {
        width: 100%;
        box-sizing: border-box;
      }

      .search-container h1 {
        font-size: 1.6rem;
      }

      #searchResults a {
        font-size: 1.1rem;
      }

      .scrollable-box a {
        font-size: 1.05rem;
        padding: 0.4rem 0.6rem;
      }

      .search-container {
        padding: 1.5rem 1rem;
        width: 100%;
        margin: 0 auto;
      }

      .time-remaining {
        font-size: 4rem;
        flex-direction: column;
        gap: 0.5rem;
      }
    }

  </style>
</head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-F7NERFLG67"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-F7NERFLG67');
</script>
<body>
  <div id="app">
    <!-- Dinamikusan betöltött tartalom ide kerül -->
  </div>

  <script>
    const apiKey = "05f00c85-2177-4345-9103-e72960f3918d";
    const app = document.getElementById("app");
    const params = new URLSearchParams(window.location.search);
    const stopId = params.get("stop");

    function normalizeQuery(str) {
      return str
        .toLowerCase()
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .replace(/\s+/g, "-");
    }

    async function fetchDepartures(url) {
      app.innerHTML = `
        <div class="time-remaining" id="timeRemainingContainer"><span></span></div>
        <div class="departure-info" id="departureTimeInfo"></div>
        <div class="error" id="errorMessage"></div>
      `;

      const timeRemainingContainer = document.getElementById("timeRemainingContainer");
      const timeInfoEl = document.getElementById("departureTimeInfo");
      const errEl = document.getElementById("errorMessage");

      try {
        const response = await fetch(url);
        const data = await response.json();
        const stopTimes = data.data.entry.stopTimes;
        const references = data.data.references;

        const stopData = references.stops?.[stopId];
        if (stopData?.name) {
          document.title = stopData.name + " – indul";
        }

        if (!stopTimes || stopTimes.length === 0) {
          timeRemainingContainer.innerHTML = `<span></span>`;
          timeInfoEl.textContent = "Nem indul járat a következő 3 órában.";
          return;
        }

        const sorted = stopTimes
          .map(e => ({
            ...e,
            actualDeparture: e.predictedDepartureTime || e.departureTime
          }))
          .filter(e => e.actualDeparture * 1000 > Date.now())
          .sort((a, b) => a.actualDeparture - b.actualDeparture);

        const next = sorted[0];
        if (!next) {
          timeRemainingContainer.innerHTML = `<span></span>`;
          timeInfoEl.textContent = "Nem indul járat a megállóból.";
          return;
        }

        const now = Date.now();
        const scheduled = next.departureTime * 1000;
        const actual = next.predictedDepartureTime ? next.predictedDepartureTime * 1000 : scheduled;

        const remainingMin = Math.floor((actual - now) / 60000);
        const departureDate = new Date(actual);
        const timeStr = departureDate.toLocaleTimeString("hu-HU", { hour: '2-digit', minute: '2-digit' });

        let displayTime = "";
        if (remainingMin < 1) {
          displayTime = "1 percen belül";
        } else if (remainingMin < 30) {
          displayTime = `${remainingMin} perc múlva`;
        } else {
          displayTime = timeStr;
        }

        let html = "";
        if (next.predictedDepartureTime) {
          html += `<span class="realtime-indicator"></span>`;
        }
        html += `<span id="timeRemaining">${displayTime}</span>`;
        timeRemainingContainer.innerHTML = html;

        timeInfoEl.classList.remove("time-delayed", "time-on-time");

        if (next.predictedDepartureTime && next.predictedDepartureTime !== next.departureTime) {
          const delay = Math.round((next.predictedDepartureTime - next.departureTime) / 60);
          timeInfoEl.textContent = delay > 0 ? `${timeStr} (+${delay}')` : (delay < 0 ? `${timeStr} (${delay}')` : `${timeStr}`);
          timeInfoEl.classList.add("time-delayed");
        } else if (next.predictedDepartureTime) {
          timeInfoEl.textContent = `${timeStr}`;
          timeInfoEl.classList.add("time-on-time");
        } else {
          timeInfoEl.textContent = displayTime === timeStr ? `` : `${timeStr}`;
        }

        if (next.tripId && references.trips?.[next.tripId]) {
          const trip = references.trips[next.tripId];
          const route = references.routes?.[trip.routeId];
          if (route) {
            const routeInfo = document.createElement("div");
            routeInfo.className = "route-info";
            const routeColor = `#${route.color || "333"}`;
            const textColor = `#${route.textColor || "fff"}`;
            routeInfo.innerHTML = `
              <span style="display: inline-block; background-color: ${routeColor}; color: ${textColor}; padding: 4px 4px; border-radius: 6px; font-weight: bold; margin-right: 8px; font-size: 1rem; min-width: 40px; text-align: center;">
                ${route.shortName}
              </span>
              <span style="color: black; font-size: 1rem;">\u25B6</span>
              <span style="color: black; font-size: 1rem;">${next.stopHeadsign || ""}</span>
            `;
            timeInfoEl.appendChild(routeInfo);

            // Járat információ lekérdezés
            const tripDetailsUrl = `https://futar.bkk.hu/api/query/v1/ws/otp/api/where/trip-details?date=20250523&minResult=1&appVersion=1.0&includeReferences=true&tripId=${next.tripId}&version=4&key=${apiKey}`;
            try {
              const tripResponse = await fetch(tripDetailsUrl);
              const tripData = await tripResponse.json();
              const vehicle = tripData?.data?.entry?.vehicle;
            
              if (vehicle?.model) {
                const modelInfo = document.createElement("div");
                modelInfo.className = "vehicle-info";
                modelInfo.textContent = vehicle.model;
                timeInfoEl.appendChild(modelInfo);
              }

              if (vehicle?.stopSequence) {
                const stopSequence = vehicle.stopSequence;
                const stopTimes = tripData.data.entry.stopTimes;
                const found = stopTimes.find(item => item.stopSequence === stopSequence);
                if (found) {
                  if (found.stopId !== stopId && tripData.data.references.stops[found.stopId].parentStationId !== stopId) {
                    const nextStopName = tripData.data.references.stops[found.stopId].name;
                    const nextStop = document.createElement("div");
                    nextStop.className = "next-stop";
                    nextStop.textContent = `${nextStopName} előtt tart`;
                    timeInfoEl.appendChild(nextStop);
                  }
                }
              }
            } catch (tripErr) {
              console.error("Trip részletek lekérése sikertelen:", tripErr);
            }
          }
        }

        if (!sorted[1]) {
          return;
        }
        // További járatok
        const upcomingContainer = document.createElement("div");
        upcomingContainer.style.margin = "2rem";
        upcomingContainer.style.textAlign = "left";
        upcomingContainer.innerHTML = `<strong style="font-size: 1rem;">További induló járatok:</strong>`;

        const upcomingList = document.createElement("div");
        upcomingList.style.marginTop = "0.5rem";

        sorted.slice(1, 4).forEach(trip => {
          const scheduled = trip.departureTime * 1000;
          const actual = trip.predictedDepartureTime ? trip.predictedDepartureTime * 1000 : scheduled;
          const delayMin = trip.predictedDepartureTime && trip.predictedDepartureTime !== trip.departureTime
            ? Math.round((trip.predictedDepartureTime - trip.departureTime) / 60)
            : 0;
          const remainingMin = Math.floor((actual - Date.now()) / 60000);
          const timeStr = new Date(actual).toLocaleTimeString("hu-HU", { hour: '2-digit', minute: '2-digit' });

          const isRealtime = trip.predictedDepartureTime !== undefined;
          const isDelayed = delayMin !== 0;

          const route = references.trips?.[trip.tripId]?.routeId;
          const routeData = references.routes?.[route];
          const shortName = routeData?.shortName || "";
          const routeColor = `#${routeData?.color || "333"}`;
          const textColor = `#${routeData?.textColor || "fff"}`;

          const item = document.createElement("div");
          item.style.display = "flex";
          item.style.alignItems = "center";
          item.style.gap = "10px";
          item.style.margin = "0.4rem 0";

          item.innerHTML = `
            ${isRealtime ? '<span class="realtime-indicator" style="width: 8px; height: 8px;"></span>' : '<span style="width: 8px; height: 8px;"></span>'}  
            <span style="flex-shrink: 0; background-color: ${routeColor}; color: ${textColor}; padding: 2px 4px; min-width: 20px; text-align: center; border-radius: 4px; font-size: 0.8rem; font-weight: bold;">${shortName}</span>
            <span style="flex-shrink: 0; font-size: 0.8rem;">\u25B6</span>
            <span style="flex-grow: 1; font-size: 0.8rem;">${trip.stopHeadsign || ""}</span>
            <span style="text-align: right; font-size: 0.8rem; ${isDelayed ? 'color: #dc3545;' : (isRealtime ? 'color: #28a745;' : '')}">
              ${remainingMin < 30 ? (remainingMin < 1 ? `<1'` : `${remainingMin}'`) : `${timeStr}`}
              ${isDelayed ? (delayMin > 0 ? `(+${delayMin}')` : `(${delayMin}')`) : ''}
            </span>
          `;

          upcomingList.appendChild(item);
        });

        upcomingContainer.appendChild(upcomingList);
        app.appendChild(upcomingContainer);


      } catch (err) {
        timeRemainingContainer.innerHTML = `<span></span>`;
        timeInfoEl.textContent = "";
        errEl.textContent = "Hiba történt az adatok lekérésekor.";
        console.error("Hiba:", err);
      }
    }

    function renderSearch() {
      app.innerHTML = `
        <div class="search-container">
          <h1>Keress egy megállót!</h1>
          <input type="text" id="searchInput" placeholder="Megálló neve...">
          <div style="margin-top: 1rem; font-size: 1rem;">
            <label><input type="radio" name="stopType" value="stop-area" checked> Megállócsoport</label>
            <label style="margin-left: 1rem;"><input type="radio" name="stopType" value="stop"> Konkrét megálló</label>
          </div>
          <br>
          <button id="searchBtn">Keresés</button>
          <div id="searchResults" class="scrollable-box"></div>
          <div style="margin-top: 1rem; display: flex; align-items: center; justify-content: center; gap: 0.5rem; font-size: 0.7rem;">
            <span>Adatforrás:</span>
            <a href="https://opendata.bkk.hu/home" target="_blank"><img src="BKK_logo.png" alt="BKK logo" style="height: 20px; object-fit: contain;"></a>
          </div>
        </div>
      `;

      const searchInput = document.getElementById("searchInput");
      const searchButton = document.getElementById("searchBtn");
      const resultsContainer = document.getElementById("searchResults");

      function getTypeEmoji(type) {
        switch (type) {
          case "RAIL": return "🚂"; // Vonat
          case "SUBWAY": return "🚇"; // Metró
          case "SUBURBAN_RAILWAY": return "🚈"; // HÉV
          case "TRAM": return "🚋"; // Villamos
          case "BUS": return "🚌"; // Busz
          case "COACH": return "🚌"; // Busz
          case "TROLLEYBUS": return "🚎"; // Troli
          case "FERRY": return "🛳️"; // Hajó
          case "CABLE_CAR": return "🚠"; // Libegő
          default: return "🚏"; // Általános
        }
      }

      async function performSearch() {
        const input = searchInput.value.trim();
        const query = normalizeQuery(input);
        const selectedType = document.querySelector('input[name="stopType"]:checked').value;

        const url = `https://futar.bkk.hu/api/query/v1/ws/otp/api/where/search?minResult=1&appVersion=1.0&includeReferences=true&query=${query}&version=4&key=${apiKey}`;
        resultsContainer.innerHTML = "Keresés...";

        try {
          const res = await fetch(url);
          const json = await res.json();
          const stops = json.data.references.stops;
          const stopIds = json.data.entry.stopIds || [];

          const filteredStops = stopIds
            .map(id => stops[id])
            .filter(stop => {
              if (selectedType === "stop-area") {
                return stop.locationSubType === "stop-area";
              } else {
                return stop.locationSubType !== "stop-area";
              }
            });

          if (filteredStops.length === 0) {
            resultsContainer.innerHTML = "Nincs találat.";
            return;
          }

          const html = filteredStops.map(stop => {
            const typeEmoji = getTypeEmoji(stop.type);
            return `<div><a href="?stop=${encodeURIComponent(stop.id)}">${typeEmoji} ${stop.name}</a></div>`;
          }).join("");

          resultsContainer.innerHTML = html;
        } catch (e) {
          resultsContainer.innerHTML = "Hiba történt a keresés során.";
          console.error(e);
        }
      }

      searchInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          performSearch();
        }
      });

      searchButton.addEventListener("click", performSearch);
    }

    if (!stopId) {
      renderSearch();
    } else {
      const url = `https://futar.bkk.hu/api/query/v1/ws/otp/api/where/arrivals-and-departures-for-stop?minResult=1&appVersion=1.0&includeReferences=true&minutesAfter=180&stopId=${stopId}&version=4&onlyDepartures=false&minutesBefore=0&key=${apiKey}`;
      fetchDepartures(url);
      setInterval(() => fetchDepartures(url), 30000);
    }
  </script>
</body>
</html>
