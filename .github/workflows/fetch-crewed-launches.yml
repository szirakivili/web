name: Fetch Upcoming Crewed Launches (hourly)

on:
  schedule:
    - cron: '15 * * * *'   # óránként: minden egész óra 15 perckor
  workflow_dispatch:     # kézzel is indítható

permissions:
  contents: write        # szükséges a pusholáshoz

jobs:
  fetch:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: pip install requests

      - name: Fetch crewed launches JSON and save
        env:
          API_URL: 'https://ll.thespacedevs.com/2.3.0/launches/upcoming/?is_crewed=true&format=json&mode=detailed&limit=10'
        run: |
          python - <<'PY'
          import os, requests, json, datetime
          url = os.environ['API_URL']
          resp = requests.get(url, timeout=30)
          resp.raise_for_status()
          payload = resp.json()
          # adjuk hozzá a lekérés időbélyegét, hogy tudd mikor történt a fetch
          out = {
            "fetched_at": datetime.datetime.utcnow().replace(microsecond=0).isoformat() + "Z",
            "source_url": url,
            "payload": payload
          }
          os.makedirs('data', exist_ok=True)
          with open('data/upcoming_crewed_launches.json', 'w', encoding='utf-8') as f:
              json.dump(out, f, ensure_ascii=False, indent=2)
          print("Saved data/upcoming_crewed_launches.json")
          PY

      - name: Commit and push if changed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          # csak akkor commitolunk, ha van változás
          if [ -n "$(git status --porcelain)" ]; then
            git add data/upcoming_crewed_launches.json
            git commit -m "Hourly update: upcoming crewed launches $(date -u +'%Y-%m-%d %H:%M UTC')"
            git push
          else
            echo "No changes to commit"
          fi
